<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ event.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.8.0.js"></script>
  <style>
    body { background-color: #000; color: #fff; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 900px; margin: auto; padding: 1rem; }
    .video-box { width: 100%; background-color: #111; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #333; margin-bottom: 1rem; }
    #agora-video { width: 100%; max-height: 60vh; border-radius: 10px; border: 2px solid limegreen; object-fit: cover; }
    .chat { background-color: #111; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    input, select, button { padding: 0.5rem; border: none; border-radius: 5px; margin: 0.2rem; }
    input { width: 70%; background-color: #222; color: #fff; }
    #sendBtn { background-color: limegreen; color: #000; font-weight: bold; }
    #likeBtn { background-color: #000; color: white; border: 2px solid red; font-weight: bold; transition: background 0.3s, color 0.3s; }
    #likeBtn.liked { background-color: red; color: #fff; }
    #leaveChatBtn { background-color: #444; color: #fff; font-weight: bold; }
    #sendGiftBtn { background-color: orange; color: #000; font-weight: bold; }
    .viewer-count { margin-bottom: 1rem; }
    #member-list { margin-top: 1rem; }
  </style>
</head>
<body>
{% if not event.is_live and not user_has_paid %}
  <div class="payment-warning">âš ï¸ You need to pay <strong>50â€¯KES</strong> to join this conversation. <a href="{% url 'pay_event' event.id %}" class="pay-button">Pay with Paystack</a></div>
{% else %}
<div class="container">
  <h1>ğŸ¥ {{ event.title }}</h1>
  <div class="video-box">
    <div id="agora-video">
      <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
      <video id="remoteVideo" autoplay playsinline style="display: none;"></video>
    </div>
    {% if user.pk == event.organizer.pk %}
      <form method="post" action="{% url 'end_event' event.id %}">
        {% csrf_token %}<button type="submit" style="background:red;color:white;padding:0.5rem 1rem;margin-top:1rem;">ğŸ”´ End Live</button>
      </form>
    {% endif %}
  </div>
  <div class="viewer-count">
    {% if user.pk == event.organizer.pk and participants %}
      ğŸ‘ï¸ Viewers: {{ participants|length }}
      <div><strong>Joined Participants:</strong><ul id="member-list">{% for p in participants %}<li>ğŸŸ¢ {{ p.user.username }}</li>{% endfor %}</ul></div>
    {% else %}ğŸ‘ï¸ Viewers: {{ participant_count }}{% endif %}
  </div>
  {% if user.pk == event.organizer.pk %}
    <div id="micRequests"><h3>ğŸ¤ Mic Requests</h3><ul id="requestList"></ul></div>
  {% endif %}
  <button id="likeBtn">â¤ï¸ Like (<span id="likeCount">0</span>)</button>
  <div class="chat">
    <div id="chatArea" style="height:150px;overflow-y:auto;"></div>
    <input type="text" id="messageInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
    <button id="leaveChatBtn">Leave Chat</button>
    <form id="giftForm" method="POST" action="/events/{{ event.id }}/gift/">
      {% csrf_token %}
      <select name="amount" id="giftType">
        <option value="10">ğŸŒ¹ Rose (10â€¯KES)</option>
        <option value="20">ğŸ« Chocolate (20â€¯KES)</option>
        <option value="50">â­ Star (50â€¯KES)</option>
      </select>
      <button type="submit" id="sendGiftBtn">Send Gift</button>
    </form>
  </div>
</div>
{% endif %}
<script>
  const CHANNEL = '{{ event.id|escapejs }}';
  const isOrganizer = "{{ user.pk }}" === "{{ event.organizer.pk }}";
  const organizerId = "{{ organizer_id|default:'0' }}";
  let rtc = { client: null, localStream: null, remoteStream: null };

  function getRandomUid() { return Math.floor(Math.random() * 10000) + 1; }

  async function initAgora() {
    rtc.client = AgoraRTC.createClient({ mode: 'live', codec: 'vp8' });
    const uid = getRandomUid();
    try {
      const response = await fetch(`/getToken?channel=${CHANNEL}&organizer_id=${organizerId}`);
      if (!response.ok) throw new Error(`Token fetch failed: ${response.status} ${response.statusText}`);
      const data = await response.json();
      const token = data.token;
      if (!token) throw new Error('No token received: ' + JSON.stringify(data));
      console.log('Received token:', token, 'UID:', data.uid);
      if (isOrganizer) {
        rtc.client.setClientRole('host');
        await startLocalStream(token, data.uid);
      } else {
        rtc.client.setClientRole('audience');
        await joinChannel(token, data.uid);
      }
      rtc.client.on('stream-added', (evt) => {
        console.log('Stream added:', evt.stream.getId());
        rtc.client.subscribe(evt.stream);
      });
      rtc.client.on('stream-subscribed', (evt) => {
        console.log('Stream subscribed:', evt.stream.getId());
        rtc.remoteStream = evt.stream;
        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.srcObject = new MediaStream(evt.stream.getTracks());
        remoteVideo.style.display = 'block';
      });
      rtc.client.on('peer-leave', () => {
        console.log('Peer left');
        if (rtc.remoteStream) {
          rtc.remoteStream.close();
          document.getElementById('remoteVideo').style.display = 'none';
        }
      });
      updateMemberList();
    } catch (err) {
      console.error('Agora error:', err);
      alert('Agora failed. Check console or contact support.');
    }
  }

  async function startLocalStream(token, uid) {
    try {
      console.log('Initializing local stream for UID:', uid);
      [rtc.localStream] = await AgoraRTC.createMicrophoneAndCameraTracks({ microphoneId: true, cameraId: true });
      if (!rtc.localStream || !rtc.localStream.getTracks().some(track => track.kind === 'video')) {
        console.error('No video track available, check camera permissions');
        alert('Please allow camera access to stream.');
        return;
      }
      console.log('Local stream tracks:', rtc.localStream.getTracks());
      await rtc.client.join(token, CHANNEL, uid, { tokenExpiryTime: 3600 });
      console.log('Joined channel as host, publishing stream');
      await rtc.client.publish(rtc.localStream);
      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = new MediaStream(rtc.localStream.getTracks());
      localVideo.style.display = 'block';
      console.log('Stream started for UID:', uid);
      createMember(uid);
    } catch (err) {
      console.error('Stream error:', err);
    }
  }

  async function joinChannel(token, uid) {
    try {
      console.log('Joining channel as audience with UID:', uid);
      await rtc.client.join(token, CHANNEL, uid, { tokenExpiryTime: 3600 }, () => console.log('Joined as viewer', uid), (err) => console.error('Join failed:', err));
      createMember(uid);
    } catch (err) {
      console.error('Join error:', err);
    }
  }

  function leaveChannel() {
    if (rtc.localStream) rtc.localStream.close();
    if (rtc.remoteStream) rtc.remoteStream.close();
    rtc.client.leave(() => console.log('Left channel'), (err) => console.error('Leave error:', err));
    deleteMember();
    document.getElementById('localVideo').style.display = 'none';
    document.getElementById('remoteVideo').style.display = 'none';
  }

  function createMember(uid) {
    fetch('/createMember', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: "{{ request.user.username|escapejs }}", UID: uid, room_name: CHANNEL })
    }).catch(err => console.error('Member creation error:', err));
  }

  function deleteMember() {
    fetch('/deleteMember', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: "{{ request.user.username|escapejs }}", UID: getRandomUid(), room_name: CHANNEL })
    }).catch(err => console.error('Member deletion error:', err));
  }

  function updateMemberList() {
    fetch(`/getMember?UID=${getRandomUid()}&room_name=${CHANNEL}`)
      .then(response => response.json())
      .then(data => {
        if (data.name) {
          const list = document.getElementById('member-list');
          list.innerHTML = `<li>ğŸŸ¢ ${data.name}</li>`; // Simplify for now
        }
      })
      .catch(err => console.error('Member list update error:', err));
  }

  const wsScheme = location.protocol === "https:" ? "wss" : "ws";
  const user = "{{ request.user.username|escapejs }}";
  const eventId = "{{ event.id|escapejs }}";
  const chatSocket = new WebSocket(`${wsScheme}://${location.host}/ws/chat/${eventId}/`);
  const likeSocket = new WebSocket(`${wsScheme}://${location.host}/ws/event/${eventId}/`);
  const streamSocket = new WebSocket(`${wsScheme}://${location.host}/ws/stream/${eventId}/`);

  let liked = false;
  let localMicStream = null;

  function floatEmoji(content) {
    const el = document.createElement("div"); el.className = "float-emoji"; el.innerText = content;
    document.body.appendChild(el); setTimeout(() => el.remove(), 4000);
  }

  function giftLabel(value) {
    return { '10': 'ğŸŒ¹ Coin x10', '20': 'ğŸ« Chocolate (20â€¯KES)', '50': 'â­ Star (50â€¯KES)' }[value] || `ğŸ Coin x${value}`;
  }

  streamSocket.onopen = () => (isOrganizer ? streamSocket.send(JSON.stringify({ type: "live_started", event_id: eventId })) : streamSocket.send(JSON.stringify({ type: "check_stream", viewer_id: user })));
  streamSocket.onmessage = async (e) => { if (JSON.parse(e.data).type === "live_started" && !isOrganizer) { const { token, uid } = await (await fetch(`/getToken?channel=${CHANNEL}&organizer_id=${organizerId}`)).json(); await joinChannel(token, uid); } };

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === "chat") {
      const p = document.createElement("p"); p.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
      document.getElementById("chatArea").appendChild(p).scrollIntoView();
    } else if (data.type === "mic_request" && isOrganizer) {
      const li = document.createElement("li"); li.id = `mic-${data.username}`;
      li.innerHTML = `${data.username} requests mic <button onclick="approveMic('${data.username}')">âœ…</button><button onclick="denyMic('${data.username}')">âŒ</button>`;
      document.getElementById("requestList").appendChild(li);
    } else if (data.type === "mic_approved") {
      if (!isOrganizer && data.username === user) navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(stream => { localMicStream = stream; document.getElementById("remoteVideo").srcObject = stream; document.getElementById("remoteVideo").style.display = "block"; floatEmoji("ğŸ¤ğŸ¥ You are live!"); }).catch(err => alert(`Mic error: ${err.message}`));
      else document.getElementById(`mic-${data.username}`)?.remove();
    } else if (data.type === "mic_denied") (data.username === user ? alert("âŒ Mic request denied.") : document.getElementById(`mic-${data.username}`)?.remove());
    else if (data.type === "mic_revoked" && data.username === user) { if (localMicStream) localMicStream.getTracks().forEach(t => t.stop()); localMicStream = null; document.getElementById("remoteVideo").srcObject = null; document.getElementById("remoteVideo").style.display = "none"; alert("ğŸ”‡ Mic revoked."); }
  };

  likeSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === "like_update") { document.getElementById("likeCount").innerText = data.total_likes; floatEmoji("â¤ï¸"); }
    else if (data.type === "gift") { const p = document.createElement("p"); p.textContent = `ğŸ ${data.user} sent ${giftLabel(data.gift)}`; p.style.color = "orange"; document.getElementById("chatArea").appendChild(p); floatEmoji(`ğŸ ${data.user} sent ${giftLabel(data.gift)}`); }
    else if (data.type === "live_started") document.getElementById("videoPlaceholder")?.remove();
  };

  document.getElementById("sendBtn").onclick = () => { const msg = document.getElementById("messageInput").value.trim(); if (msg && chatSocket.readyState === WebSocket.OPEN) { chatSocket.send(JSON.stringify({ type: "message", message: msg })); document.getElementById("messageInput").value = ""; } };
  document.getElementById("messageInput").addEventListener("keypress", e => e.key === "Enter" && document.getElementById("sendBtn").click());
  document.getElementById("likeBtn").onclick = () => { if (likeSocket.readyState === WebSocket.OPEN) { likeSocket.send(JSON.stringify({ action: liked ? "unlike" : "like", event_id: eventId })); liked = !liked; document.getElementById("likeBtn").classList.toggle("liked", liked); } };

  function approveMic(username) { chatSocket.send(JSON.stringify({ type: "mic_approved", username })); }
  function denyMic(username) { chatSocket.send(JSON.stringify({ type: "mic_denied", username })); }
  function revokeMic(username) { chatSocket.send(JSON.stringify({ type: "mic_revoked", username })); }

  document.getElementById("leaveChatBtn").onclick = () => { leaveChannel(); window.location.href = "{% url 'landing' %}"; };
  const micBtn = document.getElementById("requestMicBtn"); if (micBtn) micBtn.onclick = () => { chatSocket.send(JSON.stringify({ type: "mic_request", username: user })); micBtn.disabled = true; };
</script>
