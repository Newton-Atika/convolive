<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ event.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Agora Web SDK -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.23.1.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    .video-box {
      width: 100%;
      background-color: #111;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #333;
      margin-bottom: 1rem;
    }
    #agora-video {
      width: 100%;
      max-height: 60vh;
      border-radius: 10px;
      border: 2px solid limegreen;
      object-fit: cover;
    }
    .chat {
      background-color: #111;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    input, select, button {
      padding: 0.5rem;
      border: none;
      border-radius: 5px;
      margin: 0.2rem;
    }
    input {
      width: 70%;
      background-color: #222;
      color: #fff;
    }
    #sendBtn {
      background-color: limegreen;
      color: #000;
      font-weight: bold;
    }
    #likeBtn {
      background-color: #000;
      color: white;
      border: 2px solid red;
      font-weight: bold;
      transition: background 0.3s, color 0.3s;
    }
    #likeBtn.liked {
      background-color: red;
      color: #fff;
    }
    #leaveChatBtn {
      background-color: #444;
      color: #fff;
      font-weight: bold;
    }
    #sendGiftBtn {
      background-color: orange;
      color: #000;
      font-weight: bold;
    }
    .viewer-count {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

{% if not event.is_live and not user_has_paid %}
  <div class="payment-warning">
    ‚ö†Ô∏è You need to pay <strong>50‚ÄØKES</strong> to join this conversation.
    <a href="{% url 'pay_event' event.id %}" class="pay-button">Pay with Paystack</a>
  </div>
{% else %}
<div class="container">
  <h1>üé• {{ event.title }}</h1>

  <div class="video-box">
    <!-- Agora video area -->
    <div id="agora-video">
      <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
      <video id="remoteVideo" autoplay playsinline style="display: none;"></video>
    </div>

    {% if user.pk == event.organizer.pk %}
      <form method="post" action="{% url 'end_event' event.id %}">
        {% csrf_token %}
        <button type="submit" style="background:red;color:white;padding:0.5rem 1rem;margin-top:1rem;">üî¥ End Live</button>
      </form>
    {% endif %}
  </div>

  <div class="viewer-count">
    {% if user.pk == event.organizer.pk and participants %}
      üëÅÔ∏è Viewers: {{ participants|length }}
      <div><strong>Joined Participants:</strong>
        <ul>{% for p in participants %}<li>üü¢ {{ p.user.username }}</li>{% endfor %}</ul>
      </div>
    {% else %}
      üëÅÔ∏è Viewers: {{ participant_count }}
    {% endif %}
  </div>

  {% if user.pk == event.organizer.pk %}
    <div id="micRequests">
      <h3>üé§ Mic Requests</h3>
      <ul id="requestList"></ul>
    </div>
  {% endif %}

  <button id="likeBtn">‚ù§Ô∏è Like (<span id="likeCount">0</span>)</button>

  <div class="chat">
    <div id="chatArea" style="height:150px;overflow-y:auto;"></div>
    <input type="text" id="messageInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
    <button id="leaveChatBtn">Leave Chat</button>
    <form id="giftForm" method="POST" action="/events/{{ event.id }}/gift/">
      {% csrf_token %}
      <select name="amount" id="giftType">
        <option value="10">üåπ Rose (10‚ÄØKES)</option>
        <option value="20">üç´ Chocolate (20‚ÄØKES)</option>
        <option value="50">‚≠ê Star (50‚ÄØKES)</option>
      </select>
      <button type="submit" id="sendGiftBtn">Send Gift</button>
    </form>
  </div>
</div>
{% endif %}

<script>
const APP_ID = '5a7551a1892a47258b7e9f7f264e6196';
const CHANNEL = '{{ event.id|escapejs }}';
const isOrganizer = {{ is_organizer|safe }};
const eventIsLive = {{ event.is_live|lower|safe }};
const WEBSOCKET_URL = `wss://web-production-816d1.up.railway.app/ws/stream/${CHANNEL}/`;
let streamSocket, reconnectAttempts = 0, maxReconnectAttempts = 5;

function initializeWebSocket() {
    try {
        streamSocket = new WebSocket(WEBSOCKET_URL);
        streamSocket.onopen = () => {
            console.log(`WebSocket connected to ${WEBSOCKET_URL} for event ${CHANNEL} (isOrganizer: ${isOrganizer})`);
            reconnectAttempts = 0; // Reset on successful connection
            if (isOrganizer && eventIsLive) {
                streamSocket.send(JSON.stringify({ type: "live_started" }));
                console.log("Sent live_started message");
            } else {
                streamSocket.send(JSON.stringify({ type: "check_stream" }));
                console.log("Sent check_stream message");
            }
        };
        streamSocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting reconnect (${reconnectAttempts}/${maxReconnectAttempts}) in 5 seconds...`);
                setTimeout(initializeWebSocket, 5000);
            } else {
                console.error('Max reconnect attempts reached. WebSocket failed.');
            }
        };
        streamSocket.onclose = (event) => {
            console.log(`WebSocket closed for ${WEBSOCKET_URL}, code: ${event.code}, reason: ${event.reason}`);
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting reconnect (${reconnectAttempts}/${maxReconnectAttempts}) in 5 seconds...`);
                setTimeout(initializeWebSocket, 5000);
            } else {
                console.error('Max reconnect attempts reached. WebSocket failed.');
            }
        };
        streamSocket.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            console.log('WebSocket message received:', data);
            if ((data.type === "live_started" || data.type === "stream_active") && !isOrganizer) {
                console.log("üöÄ Viewer received live_started/stream_active signal");
                try {
                    const resp = await fetch(`/get-agora-token/?event_id=${CHANNEL}`);
                    if (!resp.ok) {
                        const errorText = await resp.text();
                        console.error(`Viewer failed to fetch token: ${errorText}`);
                        throw new Error(`Viewer failed to fetch token: ${errorText}`);
                    }
                    const { token, uid, role } = await resp.json();
                    console.log(`Viewer fetched token: ${token}, uid: ${uid}, role: ${role}`);
                    await joinChannel(token, uid);
                } catch (err) {
                    console.error("Viewer join error:", err);
                    alert(`Failed to join channel: ${err.message}`);
                }
            } else if (data.type === "mic_request" && isOrganizer) {
                const requestList = document.getElementById("requestList");
                const li = document.createElement("li");
                li.textContent = `üé§ ${data.username} requested mic`;
                requestList.appendChild(li);
            } else if (data.type === "like_update") {
                const likeButton = document.querySelector(".like-button");
                if (likeButton) {
                    likeButton.textContent = `‚ù§Ô∏è Like (${data.total_likes})`;
                }
            } else if (data.type === "gift") {
                console.log(`Gift received: ${data.gift} from ${data.user}`);
            }
        };
    } catch (err) {
        console.error('Failed to initialize WebSocket:', err);
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Attempting reconnect (${reconnectAttempts}/${maxReconnectAttempts}) in 5 seconds...`);
            setTimeout(initializeWebSocket, 5000);
        } else {
            console.error('Max reconnect attempts reached. WebSocket failed.');
        }
    }
}

const rtc = { client: null, localAudioTrack: null, localVideoTrack: null };

async function initAgora() {
    try {
        const response = await fetch(`/get-agora-token/?event_id=${CHANNEL}`);
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Organizer failed to fetch token: ${errorText}`);
            throw new Error(`Organizer failed to fetch token: ${errorText}`);
        }
        const { token, uid, role } = await response.json();
        console.log(`Organizer fetched token: ${token}, uid: ${uid}, role: ${role}, channel: ${CHANNEL}, app_id: ${APP_ID}`);

        rtc.client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });

        rtc.client.on("user-published", async (user, mediaType) => {
            try {
                console.log(`User ${user.uid} published ${mediaType}`);
                await rtc.client.subscribe(user, mediaType);
                console.log(`Subscribed to user ${user.uid} ${mediaType}`);
                if (mediaType === "video") {
                    const remoteVideo = document.getElementById("remoteVideo");
                    if (remoteVideo) {
                        user.videoTrack.play(remoteVideo);
                        remoteVideo.style.display = "block";
                        console.log(`Playing video for user ${user.uid} on remoteVideo`);
                    } else {
                        console.error("remoteVideo element not found");
                    }
                }
                if (mediaType === "audio") {
                    user.audioTrack.play();
                    console.log(`Playing audio for user ${user.uid}`);
                }
            } catch (err) {
                console.error(`Failed to subscribe to user ${user.uid} ${mediaType}:`, err);
            }
        });

        rtc.client.on("user-unpublished", (user) => {
            console.log(`User ${user.uid} unpublished`);
            const remoteVideo = document.getElementById("remoteVideo");
            if (remoteVideo) {
                remoteVideo.style.display = "none";
            }
        });

        console.log(`Attempting to join channel ${CHANNEL} with uid ${uid}, token: ${token}`);
        await rtc.client.join(APP_ID, CHANNEL, token, uid);
        console.log(`Joined channel ${CHANNEL} as uid ${uid}`);

if (isOrganizer) {
    await rtc.client.setClientRole("host");
    console.log("Set client role to host");
    try {
        rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        rtc.localVideoTrack = await AgoraRTC.createCameraVideoTrack();
        console.log("Created local audio and video tracks");

        const localVideo = document.getElementById("localVideo");
        if (localVideo) {
            rtc.localVideoTrack.play(localVideo);
            localVideo.style.display = "block";
            console.log("Playing local video");
        } else {
            console.error("localVideo element not found");
        }

        await rtc.client.publish([rtc.localAudioTrack, rtc.localVideoTrack]);
        console.log("Published local audio and video tracks");

        // ‚úÖ Only now send the WebSocket message
        if (streamSocket && streamSocket.readyState === WebSocket.OPEN) {
            streamSocket.send(JSON.stringify({ type: "live_started" }));
            console.log("‚úÖ Sent live_started after publishing");
        }

    } catch (err) {
        console.error("Failed to publish tracks:", err);
        alert(`Failed to publish video: ${err.message}`);
    }
} else {
    await rtc.client.setClientRole("audience");
    console.log("Set client role to audience");
}


async function joinChannel(token, uid) {
    try {
        console.log(`Viewer joining channel ${CHANNEL} with uid ${uid}, token: ${token}`);
        if (!rtc.client) {
            rtc.client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
            console.log("Created viewer Agora client");
            rtc.client.on("user-published", async (user, mediaType) => {
                try {
                    console.log(`Viewer: User ${user.uid} published ${mediaType}`);
                    await rtc.client.subscribe(user, mediaType);
                    console.log(`Viewer: Subscribed to user ${user.uid} ${mediaType}`);
                    if (mediaType === "video") {
                        const remoteVideo = document.getElementById("remoteVideo");
                        if (remoteVideo) {
                            user.videoTrack.play(remoteVideo);
                            remoteVideo.style.display = "block";
                            console.log(`Viewer: Playing video for user ${user.uid} on remoteVideo`);
                        } else {
                            console.error("Viewer: remoteVideo element not found");
                        }
                    }
                    if (mediaType === "audio") {
                        user.audioTrack.play();
                        console.log(`Viewer: Playing audio for user ${user.uid}`);
                    }
                } catch (err) {
                    console.error(`Viewer: Failed to subscribe to user ${user.uid} ${mediaType}:`, err);
                }
            });
            rtc.client.on("user-unpublished", (user) => {
                console.log(`Viewer: User ${user.uid} unpublished`);
                const remoteVideo = document.getElementById("remoteVideo");
                if (remoteVideo) {
                    remoteVideo.style.display = "none";
                }
            });
        }
        await rtc.client.join(APP_ID, CHANNEL, token, uid);
        await rtc.client.setClientRole("audience");
        console.log("Viewer joined as audience");
    } catch (err) {
        console.error("Viewer join error:", err);
        alert(`Failed to join channel: ${err.message}`);
    }
}

function sendLike(action) {
    if (streamSocket && streamSocket.readyState === WebSocket.OPEN) {
        streamSocket.send(JSON.stringify({
            type: "like_update",
            action: action,
            event_id: CHANNEL
        }));
        console.log(`Sent like action: ${action}`);
    }
}

function sendGift(gift) {
    if (streamSocket && streamSocket.readyState === WebSocket.OPEN) {
        streamSocket.send(JSON.stringify({
            type: "gift",
            gift: gift,
            event_id: CHANNEL
        }));
        console.log(`Sent gift: ${gift}`);
    }
}

function leaveChat() {
    if (rtc.client) {
        rtc.client.leave();
        console.log("Left Agora channel");
    }
    if (streamSocket && streamSocket.readyState === WebSocket.OPEN) {
        streamSocket.close();
        console.log("Closed WebSocket");
    }
}

window.onload = () => {
    if (eventIsLive) {
        console.log("Initializing WebSocket and Agora");
        initializeWebSocket();
        if (isOrganizer) {
            initAgora();
        }
    } else {
        console.log("Event is not live and user has not paid. Waiting for payment.");
    }
};
  // WebSocket and other logic
  const wsScheme = location.protocol === "https:" ? "wss" : "ws";
  const user = "{{ request.user.username|escapejs }}";
  const eventId = "{{ event.id|escapejs }}";

  const chatSocket = new WebSocket(`${wsScheme}://${location.host}/ws/chat/${eventId}/`);
  const likeSocket = new WebSocket(`${wsScheme}://${location.host}/ws/event/${eventId}/`);

  let liked = false;
  let localMicStream = null;
  const peerConnections = {};
  const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  let streamReady = false, pendingOffers = {};

  function floatEmoji(content) {
    const el = document.createElement("div");
    el.className = "float-emoji";
    el.innerText = content;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }

  function giftLabel(value) {
    switch (value) {
      case "10": return "üåπ Coin x10";
      case "20": return "üç´ Coin x20";
      case "50": return "‚≠ê Coin x50";
      default: return `üéÅ Coin x${value}`;
    }
  }
  // CHAT SOCKET
  chatSocket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === "chat") {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
      const chatArea = document.getElementById("chatArea");
      chatArea.appendChild(p);
      chatArea.scrollTop = chatArea.scrollHeight;
    } else if (data.type === "mic_request" && isOrganizer) {
      const li = document.createElement("li");
      li.id = `mic-${data.username}`;
      li.innerHTML = `${data.username} requests mic 
        <button onclick="approveMic('${data.username}')">‚úÖ</button>
        <button onclick="denyMic('${data.username}')">‚ùå</button>`;
      document.getElementById("requestList").appendChild(li);
    } else if (data.type === "mic_approved") {
      if (!isOrganizer && data.username === user) {
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
          .then(stream => {
            localMicStream = stream;
            const video = document.getElementById("remoteVideo");
            video.srcObject = stream;
            video.style.display = "block";
            floatEmoji("üé§üé• You are live!");
          })
          .catch(() => alert("Could not access camera/microphone."));
      } else {
        document.getElementById(`mic-${data.username}`)?.remove();
      }
    } else if (data.type === "mic_denied") {
      if (data.username === user) {
        alert("‚ùå Your mic request was denied.");
      } else {
        document.getElementById(`mic-${data.username}`)?.remove();
      }
    } else if (data.type === "mic_revoked" && data.username === user) {
      if (localMicStream) {
        localMicStream.getTracks().forEach(t => t.stop());
      }
      localMicStream = null;
      const video = document.getElementById("remoteVideo");
      video.srcObject = null;
      video.style.display = "none";
      alert("üîá Your mic/video access was revoked.");
    }
  };

  // LIKE SOCKET
  likeSocket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === "like_update") {
      document.getElementById("likeCount").innerText = data.total_likes;
      floatEmoji("‚ù§Ô∏è");
    } else if (data.type === "gift") {
      const p = document.createElement("p");
      p.textContent = `üéÅ ${data.user} sent ${giftLabel(data.gift)}`;
      p.style.color = "orange";
      document.getElementById("chatArea").appendChild(p);
      floatEmoji(`üéÅ ${data.user} sent ${giftLabel(data.gift)}`);
    } else if (data.type === "live_started") {
      document.getElementById("videoPlaceholder")?.remove();
    }
  };

  document.getElementById("sendBtn").onclick = () => {
    const msg = document.getElementById("messageInput").value.trim();
    if (msg && chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({ type: "message", message: msg }));
      document.getElementById("messageInput").value = "";
    }
  };

  document.getElementById("messageInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("sendBtn").click();
  });

  document.getElementById("likeBtn").onclick = () => {
    if (likeSocket.readyState === WebSocket.OPEN) {
      likeSocket.send(JSON.stringify({
        action: liked ? "unlike" : "like",
        event_id: eventId
      }));
      liked = !liked;
      document.getElementById("likeBtn").classList.toggle("liked", liked);
    }
  };

  function approveMic(username) {
    chatSocket.send(JSON.stringify({ type: "mic_approved", username }));
  }
  function denyMic(username) {
    chatSocket.send(JSON.stringify({ type: "mic_denied", username }));
  }
  function revokeMic(username) {
    chatSocket.send(JSON.stringify({ type: "mic_revoked", username }));
  }

  document.getElementById("leaveChatBtn").onclick = () => {
    leaveChannel();
    window.location.href = "{% url 'landing' %}";
  };

  const micBtn = document.getElementById("requestMicBtn");
  if (micBtn) {
    micBtn.onclick = () => {
      chatSocket.send(JSON.stringify({ type: "mic_request", username: user }));
      micBtn.disabled = true;
    };
  }
</script>

</body>
</html>
