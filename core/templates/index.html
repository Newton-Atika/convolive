<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ event.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.8.0.js"></script>
  <style>
    body { background-color: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 0 auto; padding: 1rem; }
    .video-box { width: 100%; background-color: #111; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #333; margin-bottom: 1rem; }
    #agora-video { width: 100%; max-height: 60vh; border-radius: 10px; border: 2px solid limegreen; object-fit: cover; }
    .chat { background-color: #111; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    input, button { padding: 0.5rem; border: none; border-radius: 5px; margin: 0.2rem; }
    input { width: 70%; background-color: #222; color: #fff; }
    #sendBtn { background-color: limegreen; color: #000; font-weight: bold; }
    #startStreamBtn { background-color: #00cc00; color: #fff; font-weight: bold; }
    #stopStreamBtn { background-color: #cc0000; color: #fff; font-weight: bold; }
    .debug-info { color: #ccc; font-size: 0.9em; margin-top: 1rem; max-height: 200px; overflow-y: auto; }
    .error-message { color: red; margin-top: 1rem; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸŽ¥ {{ event.title }}</h1>
  <div class="video-box">
    <div id="agora-video">
      <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
      <video id="remoteVideo" autoplay playsinline style="display: none;"></video>
    </div>
    <button id="startStreamBtn">Start Stream</button>
    <button id="stopStreamBtn" style="display: none;">Stop Stream</button>
  </div>
  <div class="debug-info" id="debug-info"></div>
  <div class="error-message" id="error-message"></div>
</div>

<script>
  const CHANNEL = '{{ event.id|escapejs }}';
  const isOrganizer = "{{ user.pk }}" === "{{ event.organizer.pk }}";
  let rtc = { client: null, localStream: null, remoteStream: null };

  function logDebug(message) {
    const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);
    console.log(`${timestamp}: ${message}`);
    document.getElementById('debug-info').textContent += `${timestamp}: ${message}\n`;
  }

  function showError(message) {
    document.getElementById('error-message').textContent = message;
  }

  async function checkDevices() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === 'videoinput');
      logDebug(`Available video devices: ${videoDevices.length} - ${videoDevices.map(d => d.label).join(', ')}`);
      if (videoDevices.length === 0) {
        showError('No camera detected. Check hardware or permissions.');
        return false;
      }
      return true;
    } catch (err) {
      logDebug('Device check error: ' + err.message);
      showError('Device check failed: ' + err.message);
      return false;
    }
  }

  async function startStream() {
    if (!await checkDevices()) return;
    rtc.client = AgoraRTC.createClient({ mode: 'live', codec: 'vp8' });
    const uid = Math.floor(Math.random() * 10000) + 1;
    try {
      const response = await fetch(`/getToken?channel=${CHANNEL}&organizer_id={{ organizer_id|default:'0' }}`);
      if (!response.ok) throw new Error(`Token fetch failed: ${response.status} ${response.statusText}`);
      const data = await response.json();
      const token = data.token;
      if (!token) throw new Error('No token received: ' + JSON.stringify(data));
      logDebug(`Received token: ${token}, UID: ${data.uid || uid}`);
      await rtc.client.join(token, CHANNEL, uid);
      logDebug('Joined channel as host');

      await navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        logDebug('Camera access granted');
      }).catch(err => {
        logDebug('Camera access denied: ' + err.message);
        showError('Camera access denied: ' + err.message);
        return;
      });

      [rtc.localStream] = await AgoraRTC.createMicrophoneAndCameraTracks({ microphoneId: true, cameraId: true });
      if (!rtc.localStream || !rtc.localStream.getTracks().some(track => track.kind === 'video' && track.enabled)) {
        logDebug('No video track available or disabled');
        showError('No video track. Please allow camera access.');
        return;
      }
      logDebug('Local stream tracks: ' + JSON.stringify(rtc.localStream.getTracks().map(track => ({ kind: track.kind, enabled: track.enabled }))));

      await rtc.client.publish(rtc.localStream);
      logDebug('Stream published successfully');

      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.srcObject = new MediaStream(rtc.localStream.getTracks());
        localVideo.style.display = 'block';
        logDebug('Local video stream assigned');
      }

      document.getElementById('startStreamBtn').style.display = 'none';
      document.getElementById('stopStreamBtn').style.display = 'block';
    } catch (err) {
      logDebug('Stream error: ' + err.message);
      showError('Stream error: ' + err.message);
    }

    rtc.client.on('stream-added', evt => {
      logDebug(`Stream added: ${evt.stream.getId()} from UID: ${evt.stream.getId()}`);
      rtc.client.subscribe(evt.stream, { audio: true, video: true });
    });

    rtc.client.on('stream-subscribed', evt => {
      logDebug(`Stream subscribed: ${evt.stream.getId()}`);
      rtc.remoteStream = evt.stream;
      const remoteVideo = document.getElementById('remoteVideo');
      if (remoteVideo) {
        remoteVideo.srcObject = new MediaStream(evt.stream.getTracks());
        remoteVideo.style.display = 'block';
        logDebug('Remote video stream assigned');
      }
    });

    rtc.client.on('peer-leave', () => {
      logDebug('Peer left');
      if (rtc.remoteStream) {
        rtc.remoteStream.close();
        document.getElementById('remoteVideo').style.display = 'none';
      }
    });
  }

  function stopStream() {
    if (rtc.localStream) rtc.localStream.close();
    if (rtc.remoteStream) rtc.remoteStream.close();
    rtc.client.leave(() => logDebug('Left channel'));
    document.getElementById('localVideo').style.display = 'none';
    document.getElementById('remoteVideo').style.display = 'none';
    document.getElementById('startStreamBtn').style.display = 'block';
    document.getElementById('stopStreamBtn').style.display = 'none';
  }

  document.getElementById('startStreamBtn').addEventListener('click', startStream);
  document.getElementById('stopStreamBtn').addEventListener('click', stopStream);

  // Auto-start for organizer if needed
  if (isOrganizer) {
    startStream();
  }
</script>
</body>
</html>
