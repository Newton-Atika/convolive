<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ event.title }}</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 1rem;
        }

        .video-box {
            width: 100%;
            background-color: #111;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #333;
            margin-bottom: 1rem;
        }

        #localVideo, #viewerStream {
            width: 100%;
            border-radius: 10px;
            border: 2px solid limegreen;
        }

        .chat {
            background-color: #111;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        input, select, button {
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            margin: 0.2rem;
        }

        input {
            width: 70%;
            background-color: #222;
            color: #fff;
        }

        #sendBtn {
            background-color: limegreen;
            color: #000;
            font-weight: bold;
        }

        #likeBtn {
            background-color: red;
            color: #fff;
        }

        #leaveChatBtn {
            background-color: #444;
            color: #fff;
            font-weight: bold;
        }

        #sendGiftBtn {
            background-color: orange;
            color: #000;
            font-weight: bold;
        }

        .viewer-count {
            margin-bottom: 1rem;
        }

        /* Floating gift animation - updated to 4s */
        .float-emoji {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: floatUp 4s ease-out forwards;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-250px);
            }
        }
    </style>
</head>
<body>

{% if not event.is_live and not user_has_paid %}
    <div style="background:#111;border:2px solid red;padding:1rem;border-radius:8px;margin:1rem;text-align:center;">
        <p>âš ï¸ You need to pay <strong>50 KES</strong> to join this conversation.</p>
        <a href="{% url 'pay_event' event.id %}" style="padding:0.6rem 1rem;background:limegreen;color:black;border-radius:5px;font-weight:bold;text-decoration:none;">Pay with Paystack</a>
    </div>
{% else %}

<div class="container">
    <h1>ğŸ¥ {{ event.title }}</h1>

    <div class="video-box">
        {% if user.pk == event.organizer.pk %}
            <video id="localVideo" autoplay muted></video>
            <form method="post" action="{% url 'end_event' event.id %}">
                {% csrf_token %}
                <button type="submit" style="background-color:red;color:white;padding:0.5rem 1rem;margin-top:1rem;">ğŸ”´ End Live</button>
            </form>
        {% else %}
            <div id="videoPlaceholder">ğŸ”’ Waiting for organizerâ€™s live video...</div>
            <button id="requestMicBtn">ğŸ™ï¸ Request to Speak</button>
            <video id="viewerStream" autoplay muted style="display:none; margin-top:10px;"></video>
        {% endif %}
    </div>

    <div class="viewer-count">
        {% if user.pk == event.organizer.pk and participants %}
            ğŸ‘ï¸ Viewers: {{ participants|length }}
            <div style="margin-top: 0.5rem;">
                <strong>Joined Participants:</strong>
                <ul>
                    {% for p in participants %}
                        <li>ğŸŸ¢ {{ p.user.username }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% else %}
            ğŸ‘ï¸ Viewers: {{ participant_count }}
        {% endif %}
    </div>

    {% if user.pk == event.organizer.pk %}
        <div id="micRequests" style="margin-top:1rem;">
            <h3>ğŸ¤ Mic Requests</h3>
            <ul id="requestList" style="list-style:none;"></ul>
        </div>
    {% endif %}

    <button id="likeBtn">â¤ï¸ Like (<span id="likeCount">0</span>)</button>

    <div class="chat">
        <div id="chatArea" style="height: 150px; overflow-y: scroll; background:#000; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="messageInput" placeholder="Type message...">
        <button id="sendBtn">Send</button>
        <button id="leaveChatBtn">Leave Chat</button>

        <div style="margin-top:1rem;">
            ğŸ Send a Gift:
            <form id="giftForm" method="POST" action="/events/{{ event.id }}/gift/">
                {% csrf_token %}
                <select name="amount" id="giftType">
                    <option value="10">ğŸŒ¹ Rose (10 KES)</option>
                    <option value="20">ğŸ« Chocolate (20 KES)</option>
                    <option value="50">â­ Star (50 KES)</option>
                </select>
                <button type="submit" id="sendGiftBtn">Send Gift</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    const eventId = "{{ event.id|escapejs }}";
    const isOrganizer = "{{ user.pk }}" === "{{ event.organizer.pk }}";
    const wsScheme = location.protocol === "https:" ? "wss" : "ws";
    const user = "{{ request.user.username|escapejs }}";

    const chatSocket = new WebSocket(`${wsScheme}://${location.host}/ws/chat/${eventId}/`);
    const likeSocket = new WebSocket(`${wsScheme}://${location.host}/ws/event/${eventId}/`);
    let liked = false;
    let localMicStream = null;

    function floatEmoji(content) {
        const el = document.createElement("div");
        el.className = "float-emoji";
        el.innerText = content;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 4000);  // Stay for 4 seconds
    }

    function giftLabel(value) {
        switch (value) {
            case "10": return "ğŸŒ¹ Coin x10";
            case "20": return "ğŸ« Coin x20";
            case "50": return "â­ Coin x50";
            default: return `ğŸ Coin x${value}`;
        }
    }

    chatSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "chat") {
            const p = document.createElement("p");
            p.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
            document.getElementById("chatArea").appendChild(p);
            document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;

        } else if (data.type === "mic_request" && isOrganizer) {
            const li = document.createElement("li");
            li.id = `mic-${data.username}`;
            li.innerHTML = `${data.username} wants to speak 
                <button onclick="approveMic('${data.username}')">âœ… Approve</button> 
                <button onclick="denyMic('${data.username}')">âŒ Deny</button>`;
            document.getElementById("requestList").appendChild(li);

        } else if (data.type === "mic_approved") {
            if (!isOrganizer && data.username === user) {
                navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
                    localMicStream = stream;
                    const video = document.getElementById("viewerStream");
                    video.srcObject = stream;
                    video.style.display = "block";
                }).catch(err => alert("Mic access denied."));
            } else if (isOrganizer) {
                const requestItem = document.getElementById(`mic-${data.username}`);
                if (requestItem) requestItem.remove();
                const revokeBtn = document.createElement("button");
                revokeBtn.textContent = `ğŸ”‡ Revoke Mic: ${data.username}`;
                revokeBtn.onclick = () => revokeMic(data.username);
                document.getElementById("requestList").appendChild(revokeBtn);
            }

        } else if (data.type === "mic_denied") {
            if (!isOrganizer && data.username === user) alert("âŒ Your mic request was denied.");
            else {
                const deniedItem = document.getElementById(`mic-${data.username}`);
                if (deniedItem) deniedItem.remove();
            }

        } else if (data.type === "mic_revoked" && !isOrganizer && data.username === user) {
            if (localMicStream) {
                localMicStream.getTracks().forEach(track => track.stop());
                localMicStream = null;
                document.getElementById("viewerStream").style.display = "none";
                alert("ğŸ”‡ Your mic access has been revoked.");
            }
        }
    };

    likeSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "like_update") {
            document.getElementById("likeCount").innerText = data.total_likes;
            floatEmoji("â¤ï¸");
        } else if (data.type === "viewer_count") {
            document.getElementById("viewerCount").innerText = data.count;
        } else if (data.type === "gift") {
            const p = document.createElement("p");
            p.textContent = `ğŸ ${data.user} sent gift: ${data.gift}`;
            p.style.color = "orange";
            document.getElementById("chatArea").appendChild(p);
            floatEmoji(`ğŸ ${data.user} sent ${giftLabel(data.gift)}`);
        } else if (data.type === "live_started") {
            const placeholder = document.getElementById("videoPlaceholder");
            if (placeholder) placeholder.remove();
        }
    };

    document.getElementById("sendBtn").onclick = () => {
        const msg = document.getElementById("messageInput").value;
        if (msg.trim() && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ type: "message", message: msg }));
            document.getElementById("messageInput").value = "";
        }
    };

    document.getElementById("messageInput").addEventListener('keypress', function (e) {
        if (e.key === 'Enter') document.getElementById("sendBtn").click();
    });

    document.getElementById("likeBtn").onclick = () => {
        if (likeSocket.readyState === WebSocket.OPEN) {
            likeSocket.send(JSON.stringify({ event_id: eventId, action: liked ? "unlike" : "like" }));
            liked = !liked;
            document.getElementById("likeBtn").innerHTML = liked
                ? `ğŸ’” Unlike (<span id="likeCount">${document.getElementById("likeCount").innerText}</span>)`
                : `â¤ï¸ Like (<span id="likeCount">${document.getElementById("likeCount").innerText}</span>)`;
        }
    };

    if (isOrganizer) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            document.getElementById("localVideo").srcObject = stream;
            if (likeSocket.readyState === WebSocket.OPEN) {
                likeSocket.send(JSON.stringify({ 'live_started': true }));
            }
        }).catch(error => alert("Could not access camera"));
    }

    const micBtn = document.getElementById("requestMicBtn");
    if (micBtn) {
        micBtn.onclick = () => {
            chatSocket.send(JSON.stringify({ type: "mic_request", username: user }));
            micBtn.disabled = true;
            micBtn.textContent = "ğŸ™ï¸ Requested...";
        };
    }

    function approveMic(username) {
        chatSocket.send(JSON.stringify({ type: "mic_approved", username }));
    }

    function denyMic(username) {
        chatSocket.send(JSON.stringify({ type: "mic_denied", username }));
    }

    function revokeMic(username) {
        chatSocket.send(JSON.stringify({ type: "mic_revoked", username }));
        const revokeButton = [...document.querySelectorAll("#requestList button")]
            .find(btn => btn.textContent.includes(username));
        if (revokeButton) revokeButton.remove();
    }

    document.getElementById("leaveChatBtn").onclick = () => {
        console.log("Leave Chat button clicked (not implemented)");
    };
</script>
</body>
</html>
